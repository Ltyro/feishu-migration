<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="cn">
<head>
    <meta charset="UTF-8">
<!--    <title th:inline="text">[[${title}]]</title>-->
    <title>飞书云文档迁移工具</title>
</head>

<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
<script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<!-- 引入二维码 SDK -->
<script src="https://lf-package-cn.feishucdn.com/obj/feishu-static/lark/passport/qrcode/LarkSSOSDKWebQRCode-1.0.3.js"></script>

<body>
<div class="container">
    <div class="row align-items-center">
        <div class="col-xl-2">
        </div>

        <div class="col-xl-8">
            <!--<h1 style="margin-left: 40px; margin-top: 50px; font-size: 40px;" th:inline="text">-->
            <h1 style="margin-top: 50px;" th:inline="text">
                迁入企业的（新）飞书账号授权：
            </h1>

            <div id="defaultLoginDiv">
                <!--    <div class="description" style="font-size: 20px; margin-left: 100px; margin-top: 50px; width: 900px;">-->
                <div class="description" style="margin-top: 50px;">
                    <p th:inline="text">请在手机上将飞书切换到【[[${newTenantName}]]】，准备就绪后，点击下一步。</p>
                </div>
                <!--                <div style="margin-top: 200px; margin-left: 830px;">-->
                <!--                    <div>-->
                <!--                        <button class="btn btn-primary btn-lg" onclick="login()"-->
                <!--                                style="width: 150px;background-color: #356FF4">-->
                <!--                            下一步-->
                <!--                        </button>-->
                <!--                    </div>-->
                <!--                </div>-->

                <div class="row" style="margin-top: 50px;">
                    <div class="col-3">
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary btn-lg" onclick="login()">下一步
                            </button>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-secondary btn-lg" type="button" onclick="window.location.href = '/feishu-old'">返回
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 飞书扫码免登 -->
            <div id="qrLoginDiv" style="display:none;">
                <!--                <h3 style="text-align: center;margin-top: 160px;">扫码登录</h3>-->
                <div class="description" style="margin-top: 50px;">
                    <p th:inline="text">请在手机上将飞书切换到【[[${newTenantName}]]】，扫码授权。</p>
                </div>

                <div id="qrLogin" style="height: 480px;margin-left:-40px;">
                    <div id="login_container"></div>
                </div>

                <div class="row" style="margin-top: -140px">
                    <div class="col-3">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-secondary btn-lg" type="button" onclick="window.location.href = '/feishu-old'">返回
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2">
        </div>
    </div>
</div>
</body>
</html>

<script th:inline="javascript">
    function login() {
        const uri = [[${url}]] + '/feishu-login';
        const appId = [[${appId}]];
        window.location.href = 'https://open.feishu.cn/open-apis/authen/v1/index?redirect_uri=' + uri + '&app_id=' + appId + '&state=new';
    }

    window.onload = function () {
        const userAgent = navigator.userAgent;
        console.log(`Chrome 版本号：${userAgent}`);
        const match = userAgent.match(/Lark\/(\d+\.\d+\.\d+)/);

        if (match) {
            console.log(`Chrome 版本号：${match[1]}`);
            this.qrLogin();
        } else {
            this.defaultLogin();
        }

        let feishuQrAuthPage = /*[[${newQrAddress}]]*/ '';
        console.log("feishuQrAuthPage", feishuQrAuthPage);

        var goto = feishuQrAuthPage;

        var QRLoginObj = QRLogin({
            id: "login_container",
            goto: `${goto}`,
            width: "320",
            height: "320",
            style: "display: inline-block; margin-left: auto; margin-right: auto;"
        });

        var handleMessage = function (event) {
            // 使用 matchOrigin 和 matchData 方法来判断 message 和来自的页面 url 是否合法
            if (QRLoginObj.matchOrigin(event.origin) && QRLoginObj.matchData(event.data)) {
                var loginTmpCode = event.data.tmp_code;
                console.log("all path url: ", `${goto}&tmp_code=${loginTmpCode}`);
                // 在授权页面地址上拼接上参数 tmp_code，并跳转
                window.location.href = `${goto}&tmp_code=${loginTmpCode}`;
            }
        };

        if (typeof window.addEventListener != 'undefined') {
            window.addEventListener('message', handleMessage, false);
        } else if (typeof window.attachEvent != 'undefined') {
            window.attachEvent('onmessage', handleMessage);
        }
    }

    function qrLogin() {
        $("#qrLoginDiv").show();
        $("#defaultLoginDiv").hide();
    }

    function defaultLogin() {
        $("#qrLoginDiv").hide();
        $("#defaultLoginDiv").show();
    }
</script>